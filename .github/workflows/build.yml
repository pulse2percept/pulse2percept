name: Build

on: [push, pull_request]

jobs:
  build:
    name: Building on ${{ matrix.os }} with Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        python-version: ["3.12", "3.11", "3.10", "3.9"]
        os: [ubuntu-latest, windows-latest, macos-latest]
        exclude:
          - python-version: "3.9"
            os: macos-latest  # Skip Python 3.9 on macOS

    steps:
      # Step 1: Check out the repository
      - uses: actions/checkout@v3

      # Step 2: Set up Python
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      # Step 3: Install system dependencies (macOS only)
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install libomp
          export CPPFLAGS="-Xclang -fopenmp -I$(brew --prefix libomp)/include"
          export LDFLAGS="-L$(brew --prefix libomp)/lib -lomp"
          export PATH="$(brew --prefix libomp)/bin:$PATH"

      # Step 4: Install system dependencies (Linux only)
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libomp-dev zlib1g-dev libjpeg-turbo8-dev

      # Step 5: Install Python dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel build numpy

      # Step 6: Debug OpenMP paths (optional debugging step)
      - name: Debug OpenMP paths
        if: runner.os == 'macOS'
        run: |
          brew --prefix libomp
          ls -l $(brew --prefix libomp)/include
          ls -l $(brew --prefix libomp)/lib

      # Step 7: Install the package (Windows)
      - name: Install package (Windows)
        if: runner.os == 'windows-latest'
        run: |
          pip install .

      # Step 8: Install the package (Non-Windows)
      - name: Install package (Unix)
        if: runner.os != 'windows-latest'
        run: |
          pip install .

      # Step 9: Run tests
      - name: Run test suite with pytest
        run: |
          mkdir test_dir
          cd test_dir
          pytest --pyargs pulse2percept --cov-report=xml --cov=pulse2percept --doctest-modules
